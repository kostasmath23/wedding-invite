import * as React from "react";
import { ACTIVE_SLIDE_COMPLETE, ACTIVE_SLIDE_ERROR, ACTIVE_SLIDE_LOADING, ACTIVE_SLIDE_PLAYING, cleanup, createIcon, IconButton, label, SLIDE_STATUS_COMPLETE, SLIDE_STATUS_ERROR, SLIDE_STATUS_LOADING, SLIDE_STATUS_PLAYING, useController, useEvents, useLatest, useTimeouts, } from "../core/index.js";
const defaultSlideshowProps = {
    autoplay: false,
    delay: 3000,
};
const PlayIcon = createIcon("Play", React.createElement("path", { d: "M8 5v14l11-7z" }));
const PauseIcon = createIcon("Pause", React.createElement("path", { d: "M6 19h4V5H6v14zm8-14v14h4V5h-4z" }));
const SlideshowButton = () => {
    const { currentIndex, latestProps } = useController();
    const { setTimeout, clearTimeout } = useTimeouts();
    const { publish, subscribe } = useEvents();
    const slideshow = {
        ...defaultSlideshowProps,
        ...latestProps.current.slideshow,
    };
    const [playing, setPlaying] = React.useState(slideshow.autoplay);
    const scheduler = React.useRef();
    const refs = useLatest({
        playing,
        delay: slideshow.delay,
        currentIndex,
        finite: latestProps.current.carousel.finite,
        slidesCount: latestProps.current.slides.length,
    });
    const slideStatus = React.useRef();
    const cancelScheduler = React.useCallback(() => {
        clearTimeout(scheduler.current);
        scheduler.current = undefined;
    }, [clearTimeout]);
    const reachedLastSlide = React.useCallback(() => refs.current.finite && refs.current.currentIndex === refs.current.slidesCount - 1, [refs]);
    const scheduleNextSlide = React.useCallback(() => {
        cancelScheduler();
        if (!refs.current.playing ||
            reachedLastSlide() ||
            slideStatus.current === SLIDE_STATUS_LOADING ||
            slideStatus.current === SLIDE_STATUS_PLAYING) {
            return;
        }
        scheduler.current = setTimeout(() => {
            if (refs.current.playing) {
                slideStatus.current = undefined;
                publish("next");
            }
        }, refs.current.delay);
    }, [publish, setTimeout, cancelScheduler, refs, reachedLastSlide]);
    const togglePlaying = React.useCallback(() => {
        setPlaying((prev) => !prev);
    }, []);
    React.useEffect(() => {
        scheduleNextSlide();
    }, [currentIndex, playing, scheduleNextSlide]);
    React.useEffect(() => {
        if (playing && reachedLastSlide()) {
            setPlaying(false);
        }
    }, [currentIndex, playing, reachedLastSlide]);
    React.useEffect(() => cleanup(subscribe(ACTIVE_SLIDE_LOADING, () => {
        slideStatus.current = SLIDE_STATUS_LOADING;
        cancelScheduler();
    }), subscribe(ACTIVE_SLIDE_PLAYING, () => {
        slideStatus.current = SLIDE_STATUS_PLAYING;
        cancelScheduler();
    }), subscribe(ACTIVE_SLIDE_ERROR, () => {
        slideStatus.current = SLIDE_STATUS_ERROR;
        scheduleNextSlide();
    }), subscribe(ACTIVE_SLIDE_COMPLETE, () => {
        slideStatus.current = SLIDE_STATUS_COMPLETE;
        scheduleNextSlide();
    })), [subscribe, cancelScheduler, scheduleNextSlide]);
    const { render, labels } = latestProps.current;
    const disabled = reachedLastSlide();
    return render.buttonSlideshow ? (React.createElement(React.Fragment, null, render.buttonSlideshow({ playing, togglePlaying, disabled }))) : (React.createElement(IconButton, { label: playing ? label(labels, "Pause") : label(labels, "Play"), icon: playing ? PauseIcon : PlayIcon, renderIcon: playing ? render.iconSlideshowPause : render.iconSlideshowPlay, onClick: togglePlaying, disabled: disabled, "aria-disabled": disabled }));
};
export const Slideshow = ({ augment }) => {
    augment(({ slideshow: originalSlideshow, toolbar: { buttons, ...restToolbar }, ...restProps }) => ({
        toolbar: {
            buttons: [React.createElement(SlideshowButton, { key: "slideshow" }), ...buttons],
            ...restToolbar,
        },
        slideshow: {
            ...defaultSlideshowProps,
            ...originalSlideshow,
        },
        ...restProps,
    }));
};
export default Slideshow;
